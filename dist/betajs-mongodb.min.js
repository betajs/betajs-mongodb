/*!
betajs-mongodb - v1.0.24 - 2022-01-21
Copyright (c) Oliver Friedmann,Pablo Iglesias
Apache-2.0 Software License.
*/

var Scoped=function(){var d=function(){return{get:function(e){return"undefined"!=typeof window?e?window[e]:window:"undefined"!=typeof global?e?global[e]:global:"undefined"!=typeof self?e?self[e]:self:undefined},set:function(e,t){return"undefined"!=typeof window&&(window[e]=t),"undefined"!=typeof global&&(global[e]=t),"undefined"!=typeof self&&(self[e]=t),t},getPath:function(e){if(!e)return this.get();var t=e.split(".");if(1==t.length)return this.get(e);for(var n=this.get(t[0]),a=1;a<t.length;++a){if(!n)return n;n=n[t[a]]}return n},setPath:function(e,t){var n=e.split(".");if(1==n.length)return this.set(e,t);for(var a=this.get(n[0])||this.set(n[0],{}),i=1;i<n.length-1;++i)n[i]in a||(a[n[i]]={}),a=a[n[i]];return a[n[n.length-1]]=t}}}.call(this),f=function(){return{method:function(e,t){return function(){return t.apply(e,arguments)}},extend:function(e,t){for(var n in e=e||{},t=t||{})e[n]=t[n];return e},typeOf:function(e){return"[object Array]"===Object.prototype.toString.call(e)?"array":typeof e},isEmpty:function(e){if(null==e)return!0;if("array"==this.typeOf(e))return 0===e.length;if("object"!=typeof e)return!1;for(var t in e)return!1;return!0},matchArgs:function(e,t){var n=0,a={};for(var i in t)!0===t[i]||this.typeOf(e[n])==t[i]?(a[i]=e[n],n++):"undefined"==this.typeOf(e[n])&&n++;return a},stringify:function(e){return"function"==this.typeOf(e)?""+e:JSON.stringify(e)}}}.call(this),o=function(){return{__namespace:"Scoped",__revert:null,upgrade:function(e){var t=d.get(e||o.__namespace);if(t&&"object"===f.typeOf(t)&&t.guid===this.guid&&"string"===f.typeOf(t.version)){if(!1===this.upgradable||!1===t.upgradable)return t;for(var n=this.version.split("."),a=t.version.split("."),i=!1,r=0;r<Math.min(n.length,a.length)&&(i=parseInt(n[r],10)>parseInt(a[r],10),n[r]===a[r]);++r);return i?this.attach(e):t}return this.attach(e)},attach:function(e){e&&(o.__namespace=e);var t=d.get(o.__namespace);if(t===this)return this;if(o.__revert=t)try{var n=t.__exportScoped();this.__exportBackup=this.__exportScoped(),this.__importScoped(n)}catch(a){}return d.set(o.__namespace,this),this},detach:function(e){return e&&d.set(o.__namespace,null),"undefined"!=typeof o.__revert&&d.set(o.__namespace,o.__revert),delete o.__revert,o.__exportBackup&&this.__importScoped(o.__exportBackup),this},exports:function(e,t,n){return"object"==typeof(e=e||("undefined"!=typeof module?module:null))&&e&&"exports"in e&&(n||e.exports===this||!e.exports||f.isEmpty(e.exports))&&(e.exports=t||this),this}}}.call(this);function _(e){var o={tree:"boolean"==typeof e.tree&&e.tree,global:"boolean"==typeof e.global&&e.global,root:"object"==typeof e.root?e.root:{}};function i(e){return{route:"string"==typeof e.route?e.route:null,parent:"object"==typeof e.parent?e.parent:null,ready:"boolean"==typeof e.ready&&e.ready,children:{},watchers:[],data:{},lazy:[]}}var s=i({ready:!0});if(o.tree)if(o.global){try{window&&(s.data=window)}catch(t){}try{global&&(s.data=global)}catch(t){}try{self&&(s.data=self)}catch(t){}}else s.data=o.root;function c(e){if(!e.ready)if(!e.parent||e.parent.ready){if(e.route&&e.parent&&e.route in e.parent.data){e.data=e.parent.data[e.route],e.ready=!0;for(var t=0;t<e.watchers.length;++t)e.watchers[t].callback.call(e.watchers[t].context||this,e.data);for(var n in e.watchers=[],e.children)c(e.children[n])}}else c(e.parent)}function r(e,t){if("object"==typeof t&&e.ready)for(var n in t)e.data[n]=t[n];else e.data=t;if("object"==typeof t)for(var a in t)e.children[a]&&(e.children[a].data=t[a]);for(var i in!function r(e){if(!e.ready){e.parent&&!e.parent.ready&&r(e.parent),e.ready=!0,e.parent&&o.tree&&"object"==typeof e.parent.data&&(e.parent.data[e.route]=e.data);for(var t=0;t<e.watchers.length;++t)e.watchers[t].callback.call(e.watchers[t].context||this,e.data);e.watchers=[]}}(e),e.children)c(e.children[i])}function u(e){if(!e)return s;for(var t=e.split("."),n=s,a=0;a<t.length;++a)t[a]in n.children?n=n.children[t[a]]:(n.children[t[a]]=i({parent:n,route:t[a]}),c(n=n.children[t[a]]));return n}return{extend:function(e,t){r(u(e),t)},set:function(e,t){var n=u(e);n.data&&!function a(e){if(e.ready&&e.data)for(var t in e.data)delete e.data[t]}(n),r(n,t)},get:function(e){var t=u(e);return t.ready?t.data:null},lazy:function(e,t,n){var a=u(e);a.ready?t(n||this,a.data):a.lazy.push({callback:t,context:n})},digest:function(e){c(u(e))},obtain:function(e,t,n){!function i(e,t,n){if(e.ready)t.call(n||this,e.data);else if(e.watchers.push({callback:t,context:n}),0<e.lazy.length){var a=function(e){if(0<e.lazy.length){var t=e.lazy.shift();t.callback.call(t.context||this,e.data),a(e)}};a(e)}}(u(e),t,n)},unresolvedWatchers:function(e){return function r(e,t,n){for(var a in n=n||[],!(e=e||s).ready&&0===e.lazy.length&&0<e.watchers.length&&n.push(t),e.children){var i=e.children[a];n=r(i,(t?t+".":"")+i.route,n)}return n}(u(e),e)},__export:function(){return{options:o,nsRoot:s}},__import:function(e){o=e.options,s=e.nsRoot}}}var t=_({tree:!0,global:!0}),n=_({tree:!0}),a=function m(e,t,n,a){var i=null,r=[],o=t,s=n,c=a,u=_({tree:!0}),l=_({tree:!1}),p={global:{namespace:c},root:{namespace:s},local:{namespace:u},"default":{namespace:l},parent:{namespace:o},scope:{namespace:u,readonly:!1}},h=function(r,o,s){var c=f.matchArgs(r,{options:"object",namespaceLocator:!0,dependencies:"array",hiddenDependencies:"array",callback:!0,context:"object"}),e=f.extend({lazy:this.options.lazy},c.options||{}),u=this.resolve(c.namespaceLocator),t=function(){this.require(c.dependencies,c.hiddenDependencies,function(){for(var e=[],t=0;t<arguments.length;++t)e.push(arguments[t]);if(e[e.length-1].ns=u,this.options.compile){for(var n=[],a=0;a<r.length;++a)n.push(f.stringify(r[a]));this.compiled+=this.options.ident+"."+o+"("+n.join(", ")+");\n\n"}this.options.dependencies&&(this.dependencies[u.path]=this.dependencies[u.path]||{},c.dependencies&&c.dependencies.forEach(function(e){this.dependencies[u.path][this.resolve(e).path]=!0},this),c.hiddenDependencies&&c.hiddenDependencies.forEach(function(e){this.dependencies[u.path][this.resolve(e).path]=!0},this));var i=this.options.compile?{}:c.callback.apply(c.context||this,e);s.call(this,u,i)},this)};return e.lazy?u.namespace.lazy(u.path,t,this):t.apply(this),this};return{getGlobal:f.method(d,d.getPath),setGlobal:f.method(d,d.setPath),options:{lazy:!1,ident:"Scoped",compile:!1,dependencies:!1},compiled:"",dependencies:{},nextScope:function(){return i=i||m(this,u,s,c)},subScope:function(){var e=this.nextScope();return r.push(e),i=null,e},binding:function(e,t,n){var a;return p[e]&&p[e].readonly||(a="string"!=f.typeOf(t)?{namespace:_({tree:!0,root:t}),path:null}:this.resolve(t),p[e]=f.extend(n,a)),this},resolve:function(e){var t=e.split(":");if(1==t.length)throw"The locator '"+t[0]+"' requires a namespace.";var n=p[t[0]];if(!n)throw"The namespace '"+t[0]+"' has not been defined (yet).";return{namespace:n.namespace,path:n.path&&t[1]?n.path+"."+t[1]:n.path||t[1]}},define:function(){return h.call(this,arguments,"define",function(e,t){if(e.namespace.get(e.path))throw"Scoped namespace "+e.path+" has already been defined. Use extend to extend an existing namespace instead";e.namespace.set(e.path,t)})},assumeVersion:function(){var r=f.matchArgs(arguments,{assumption:!0,dependencies:"array",callback:!0,context:"object",error:"string"}),e=r.dependencies||[];e.unshift(r.assumption),this.require(e,function(){var e=arguments,t=e[0].replace(/[^\d\.]/g,"");e[0]=t.split(".");for(var n=0;n<e[0].length;++n)e[0][n]=parseInt(e[0][n],10);if("function"===f.typeOf(r.callback)){if(!r.callback.apply(r.context||this,r))throw"Scoped Assumption '"+r.assumption+"' failed, value is "+t+(r.error?", but assuming "+r.error:"")}else for(var a=(r.callback+"").replace(/[^\d\.]/g,"").split("."),i=0;i<Math.min(e[0].length,a.length);++i)if(parseInt(a[i],10)>e[0][i])throw"Scoped Version Assumption '"+r.assumption+"' failed, value is "+t+", but assuming at least "+r.callback})},extend:function(){return h.call(this,arguments,"extend",function(e,t){e.namespace.extend(e.path,t)})},require:function(){var t=f.matchArgs(arguments,{dependencies:"array",hiddenDependencies:"array",callback:"function",context:"object"});t.callback=t.callback||function(){};var e=t.dependencies||[],n=e.concat(t.hiddenDependencies||[]),a=n.length,i=[],r={};if(a)for(var o=function(e){this.i<i.length&&(i[this.i]=e),0==--a&&(i.push(r),t.callback.apply(t.context||this.ctx,i))},s=0;s<n.length;++s){var c=this.resolve(n[s]);s<e.length&&i.push(null),c.namespace.obtain(c.path,o,{ctx:this,i:s})}else i.push(r),t.callback.apply(t.context||this,i);return this},digest:function(e){var t=this.resolve(e);return t.namespace.digest(t.path),this},unresolved:function(e){var t=this.resolve(e);return t.namespace.unresolvedWatchers(t.path)},__export:function(){return{parentNamespace:o.__export(),rootNamespace:s.__export(),globalNamespace:c.__export(),localNamespace:u.__export(),privateNamespace:l.__export()}},__import:function(e){o.__import(e.parentNamespace),s.__import(e.rootNamespace),c.__import(e.globalNamespace),u.__import(e.localNamespace),l.__import(e.privateNamespace)}}}(0,n,n,t),e=f.extend(a,function(){return{guid:"4b6878ee-cb6a-46b3-94ac-27d91f58d666",version:"0.0.22",upgradable:!0,upgrade:o.upgrade,attach:o.attach,detach:o.detach,exports:o.exports,__exportScoped:function(){return{globalNamespace:t.__export(),rootNamespace:n.__export(),rootScope:a.__export()}},__importScoped:function(e){t.__import(e.globalNamespace),n.__import(e.rootNamespace),a.__import(e.rootScope)}}}.call(this));return(e=e.upgrade()).exports(),e}.call(this);(function(){var e=this.subScope();e.binding("module","global:BetaJS.Data.Databases.Mongo"),e.binding("base","global:BetaJS"),e.binding("data","global:BetaJS.Data"),e.define("module:",function(){return{guid:"1f507e0c-602b-4372-b067-4e19442f28f4",version:"1.0.24",datetime:1642800839792}}),e.assumeVersion("base:version","~1.0.96"),e.assumeVersion("data:version","~1.0.41"),e.define("module:MongoDatabaseTable",["data:Databases.DatabaseTable","base:Promise","base:Objs","base:Types","base:Iterators.ArrayIterator"],function(e,r,o,i,a,t){return e.extend({scoped:t},function(e){return{constructor:function(){e.constructor.apply(this,arguments),this._table_options=this._table_options||[],this._table_options.idkeys=this._table_options.idkeys||[],this._table_options.idkeys.unshift("_id"),this._table_options.datekeys=this._table_options.datekeys||[]},table:function(){return this.__table?r.create(this.__table):this._database.mongodb().mapSuccess(function(e){return this.__table=e.collection(this._table_name),this.__table},this)},primary_key:function(){return this._table_options._primary_key||"_id"},_encode:function(t,n){if(!t)return t;t=o.map(t,function(e,t){return e&&i.is_object(e)&&!e._bsontype&&(this._table_options.datekeys.includes(t)&&(n="date"),e=this._encode(e,n),n=null),"date"===n&&(e=new Date(e),n=null),e},this);var a=this._database.mongo_object_id();return this._table_options.idkeys.forEach(function(e){e in t&&!i.is_null(t[e])&&!i.is_object(t[e])&&(t[e]=new a(t[e]+""))},this),this._table_options.datekeys.forEach(function(e){e in t&&!i.is_null(t[e])&&!i.is_object(t[e])&&(t[e]=new Date(t[e]))},this),t},_decode:function(t){return t=o.clone(t,1),this._table_options.idkeys.forEach(function(e){e in t&&i.is_object_instance(t[e])&&(t[e]=t[e]+"")},this),this._table_options.datekeys.forEach(function(e){e in t&&i.is_object_instance(t[e])&&(t[e]=t[e].getTime())},this),t},_find:function(t,n){return"limit"in n&&!i.isNumber(n.limit)&&delete n.limit,this.table().mapSuccess(function(e){return t[this.primary_key()]?r.fromNativePromise(e.findOne(t,n)).mapSuccess(function(e){return new a([e])},this):r.box(e.find,e,[t,n]).mapSuccess(function(e){return r.fromNativePromise(e.toArray()).mapSuccess(function(e){return new a(e)},this)},this)},this)},_count:function(t){return this.table().mapSuccess(function(e){return r.fromNativePromise(e.count(t)).mapSuccess(function(e){return r.value(e)})})},_insertRow:function(t){return this.table().mapSuccess(function(e){return r.fromNativePromise(e.insertOne(t,this._database._options)).mapSuccess(function(e){return t},this)},this)},_insertRows:function(t){return this.table().mapSuccess(function(e){return r.fromNativePromise(e.insertMany(t)).mapSuccess(function(e){return row},this)},this)},_removeRow:function(t){return this.table().mapSuccess(function(e){return r.fromNativePromise(e.deleteOne(t))},this)},_removeRows:function(t){return this.table().mapSuccess(function(e){return r.fromNativePromise(e.deleteMany(t))},this)},_updateRow:function(a,i){return this.table().mapSuccess(function(e){var t=i,n=o.keys(i);return 0!==n.length&&n[0].startsWith("$")||(t={$set:i}),r.fromNativePromise(e.updateOne(a,t)).mapSuccess(function(){return i}).mapError(function(e){return e})},this)},updateRows:function(t,n){return this.table().mapSuccess(function(e){return r.fromNativePromise(e.updateMany(t,{$set:n}))},this)},ensureIndex:function(t){this.table().success(function(e){e.ensureIndex(o.objectBy(t,1))})},_renameTable:function(t){return this.table().mapSuccess(function(e){return r.fromNativePromise(e.rename(t))})}}})}),e.define("module:MongoDatabase",["data:Databases.Database","module:MongoDatabaseTable","base:Strings","base:Types","base:Objs","base:Promise","base:Net.Uri"],function(e,t,i,n,r,o,s,a){return e.extend({scoped:a},function(a){return{constructor:function(e,t){this.__dbUri=e;var n=s.parse(e.replace(/,[^\/]+/,""));this.__databaseName=i.strip_start(n.path,"/"),this._options=t||{},a.constructor.call(this),this.mongo_module=require("mongodb"),this.__mongo_promise=o.create(),this.__mongo_acquired=!1},_tableClass:function(){return t},mongo_object_id:function(e){return this.mongo_module.ObjectId},generate_object_id:function(e){return new this.mongo_module.ObjectId},mongodb:function(){if(!this.__mongo_acquired){this.__mongo_acquired=!0;var e=o.create(),t=r.extend(this._options,{useUnifiedTopology:!0,useNewUrlParser:!0});this.mongo_module.MongoClient.connect(this.__dbUri,t,e.asyncCallbackFunc()),e.success(function(e){this.__mongodb=e.db(this.__databaseName),this.__client=e,this.__mongo_promise.asyncSuccess(this.__mongodb)},this)}return this.__mongo_promise},destroy:function(){this.__client&&this.__client.close(),a.destroy.call(this)}}})})}).call(Scoped);