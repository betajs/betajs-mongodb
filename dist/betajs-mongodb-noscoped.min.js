/*!
betajs-mongodb - v1.0.24 - 2022-01-13
Copyright (c) Oliver Friedmann,Pablo Iglesias
Apache-2.0 Software License.
*/

(function(){var t=this.subScope();t.binding("module","global:BetaJS.Data.Databases.Mongo"),t.binding("base","global:BetaJS"),t.binding("data","global:BetaJS.Data"),t.define("module:",function(){return{guid:"1f507e0c-602b-4372-b067-4e19442f28f4",version:"1.0.24",datetime:1642092855336}}),t.assumeVersion("base:version","~1.0.96"),t.assumeVersion("data:version","~1.0.41"),t.define("module:MongoDatabaseTable",["data:Databases.DatabaseTable","base:Promise","base:Objs","base:Types","base:Iterators.ArrayIterator"],function(t,o,a,s,i,e){return t.extend({scoped:e},function(t){return{constructor:function(){t.constructor.apply(this,arguments),this._table_options=this._table_options||[],this._table_options.idkeys=this._table_options.idkeys||[],this._table_options.idkeys.unshift("_id"),this._table_options.datekeys=this._table_options.datekeys||[]},table:function(){return this.__table?o.create(this.__table):this._database.mongodb().mapSuccess(function(t){return this.__table=t.collection(this._table_name),this.__table},this)},primary_key:function(){return this._table_options._primary_key||"_id"},_encode:function(e,n){if(!e)return e;e=a.map(e,function(t,e){return t&&s.is_object(t)&&!t._bsontype&&(this._table_options.datekeys.includes(e)&&(n="date"),t=this._encode(t,n),n=null),"date"===n&&(t=new Date(t),n=null),t},this);var i=this._database.mongo_object_id();return this._table_options.idkeys.forEach(function(t){t in e&&!s.is_null(e[t])&&!s.is_object(e[t])&&(e[t]=new i(e[t]+""))},this),this._table_options.datekeys.forEach(function(t){t in e&&!s.is_null(e[t])&&!s.is_object(e[t])&&(e[t]=new Date(e[t]))},this),e},_decode:function(e){return e=a.clone(e,1),this._table_options.idkeys.forEach(function(t){t in e&&s.is_object_instance(e[t])&&(e[t]=e[t]+"")},this),this._table_options.datekeys.forEach(function(t){t in e&&s.is_object_instance(e[t])&&(e[t]=e[t].getTime())},this),e},_find:function(e,n){return"limit"in n&&!s.isNumber(n.limit)&&delete n.limit,this.table().mapSuccess(function(t){return e[this.primary_key()]?o.fromNativePromise(t.findOne(e,n)).mapSuccess(function(t){return new i([t])},this):o.box(t.find,t,[e,n]).mapSuccess(function(t){return o.fromNativePromise(t.toArray()).mapSuccess(function(t){return new i(t)},this)},this)},this)},_count:function(e){return this.table().mapSuccess(function(t){return o.fromNativePromise(t.count(e)).mapSuccess(function(t){return o.value(t)})})},_insertRow:function(e){return this.table().mapSuccess(function(t){return o.fromNativePromise(t.insertOne(e,this._database._options)).mapSuccess(function(t){return e},this)},this)},_insertRows:function(e){return this.table().mapSuccess(function(t){return o.fromNativePromise(t.insertMany(e)).mapSuccess(function(t){return row},this)},this)},_removeRow:function(e){return this.table().mapSuccess(function(t){return o.fromNativePromise(t.deleteOne(e))},this)},_removeRows:function(e){return this.table().mapSuccess(function(t){return o.fromNativePromise(t.deleteMany(e))},this)},_updateRow:function(i,s){return this.table().mapSuccess(function(t){var e=s,n=a.keys(s);return 0!==n.length&&n[0].startsWith("$")||(e={$set:s}),o.fromNativePromise(t.updateOne(i,e)).mapSuccess(function(){return s}).mapError(function(t){return t})},this)},updateRows:function(e,n){return this.table().mapSuccess(function(t){return o.fromNativePromise(t.updateMany(e,{$set:n}))},this)},ensureIndex:function(e){this.table().success(function(t){t.ensureIndex(a.objectBy(e,1))})},_renameTable:function(e){return this.table().mapSuccess(function(t){return o.fromNativePromise(t.rename(e))})}}})}),t.define("module:MongoDatabase",["data:Databases.Database","module:MongoDatabaseTable","base:Strings","base:Types","base:Objs","base:Promise","base:Net.Uri"],function(t,e,s,n,o,a,r,i){return t.extend({scoped:i},function(i){return{constructor:function(t,e){this.__dbUri=t;var n=r.parse(t.replace(/,[^\/]+/,""));this.__databaseName=s.strip_start(n.path,"/"),this._options=e||{},i.constructor.call(this),this.mongo_module=require("mongodb"),this.__mongo_promise=a.create(),this.__mongo_acquired=!1},_tableClass:function(){return e},mongo_object_id:function(t){return this.mongo_module.ObjectId},generate_object_id:function(t){return new this.mongo_module.ObjectId},mongodb:function(){if(!this.__mongo_acquired){this.__mongo_acquired=!0;var t=a.create(),e=o.extend(this._options,{useUnifiedTopology:!0,useNewUrlParser:!0});this.mongo_module.MongoClient.connect(this.__dbUri,e,t.asyncCallbackFunc()),t.success(function(t){this.__mongodb=t.db(this.__databaseName),this.__client=t,this.__mongo_promise.asyncSuccess(this.__mongodb)},this)}return this.__mongo_promise},destroy:function(){this.__client&&this.__client.close(),i.destroy.call(this)}}})})}).call(Scoped);