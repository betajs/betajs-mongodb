/*!
betajs-mongodb - v1.0.22 - 2021-12-10
Copyright (c) Oliver Friedmann,Pablo Iglesias
Apache-2.0 Software License.
*/

(function(){var t=this.subScope();t.binding("module","global:BetaJS.Data.Databases.Mongo"),t.binding("base","global:BetaJS"),t.binding("data","global:BetaJS.Data"),t.define("module:",function(){return{guid:"1f507e0c-602b-4372-b067-4e19442f28f4",version:"1.0.22",datetime:1639154925547}}),t.assumeVersion("base:version","~1.0.96"),t.assumeVersion("data:version","~1.0.41"),t.define("module:MongoDatabaseTable",["data:Databases.DatabaseTable","base:Promise","base:Objs","base:Types","base:Iterators.ArrayIterator"],function(t,a,o,i,s,e){return t.extend({scoped:e},function(t){return{constructor:function(){t.constructor.apply(this,arguments),this._table_options=this._table_options||[],this._table_options.idkeys=this._table_options.idkeys||[],this._table_options.idkeys.unshift("_id"),this._table_options.datekeys=this._table_options.datekeys||[]},table:function(){return this.__table?a.create(this.__table):this._database.mongodb().mapSuccess(function(t){return this.__table=t.collection(this._table_name),this.__table},this)},primary_key:function(){return this._table_options._primary_key||"_id"},_encode:function(e,n){if(!e)return e;e=o.map(e,function(t,e){return t&&i.is_object(t)&&!t._bsontype&&(this._table_options.datekeys.includes(e)&&(n="date"),t=this._encode(t,n),n=null),"date"===n&&(t=new Date(t),n=null),t},this);var s=this._database.mongo_object_id();return this._table_options.idkeys.forEach(function(t){t in e&&!i.is_null(e[t])&&!i.is_object(e[t])&&(e[t]=new s(e[t]+""))},this),this._table_options.datekeys.forEach(function(t){t in e&&!i.is_null(e[t])&&!i.is_object(e[t])&&(e[t]=new Date(e[t]))},this),e},_decode:function(e){return e=o.clone(e,1),this._table_options.idkeys.forEach(function(t){t in e&&i.is_object_instance(e[t])&&(e[t]=e[t]+"")},this),this._table_options.datekeys.forEach(function(t){t in e&&i.is_object_instance(e[t])&&(e[t]=e[t].getTime())},this),e},_find:function(e,n){return"limit"in n&&!i.isNumber(n.limit)&&delete n.limit,this.table().mapSuccess(function(t){return e[this.primary_key()]?a.funcCallback(t,t.findOne,e,n).mapSuccess(function(t){return new s([t])},this):a.box(t.find,t,[e,n]).mapSuccess(function(t){return a.funcCallback(t,t.toArray).mapSuccess(function(t){return new s(t)},this)},this)},this)},_count:function(e){return this.table().mapSuccess(function(t){return a.funcCallback(t,t.count,e).mapSuccess(function(t){return a.value(t)})})},_insertRow:function(e){return this.table().mapSuccess(function(t){return a.funcCallback(t,t.insertOne,e,this._database._options).mapSuccess(function(t){return e},this)},this)},_insertRows:function(e){return this.table().mapSuccess(function(t){return a.funcCallback(t,t.insertMany,e).mapSuccess(function(t){return row},this)},this)},_removeRow:function(e){return this.table().mapSuccess(function(t){return a.funcCallback(t,t.deleteOne,e)},this)},_removeRows:function(e){return this.table().mapSuccess(function(t){return a.funcCallback(t,t.deleteMany,e)},this)},_updateRow:function(s,i){return this.table().mapSuccess(function(t){var e=i,n=o.keys(i);return 0!==n.length&&n[0].startsWith("$")||(e={$set:i}),a.funcCallback(t,t.updateOne,s,e).mapSuccess(function(){return i}).mapError(function(t){return t})},this)},updateRows:function(e,n){return this.table().mapSuccess(function(t){return a.funcCallback(t,t.updateMany,e,{$set:n})},this)},ensureIndex:function(e){this.table().success(function(t){t.ensureIndex(o.objectBy(e,1))})},_renameTable:function(e){return this.table().mapSuccess(function(t){return a.funcCallback(t,t.rename,e)})}}})}),t.define("module:MongoDatabase",["data:Databases.Database","module:MongoDatabaseTable","base:Strings","base:Types","base:Objs","base:Promise","base:Net.Uri"],function(t,e,i,n,a,o,c,s){return t.extend({scoped:s},function(s){return{constructor:function(t,e){this.__dbUri=t;var n=c.parse(t.replace(/,[^\/]+/,""));this.__databaseName=i.strip_start(n.path,"/"),this._options=e||{},s.constructor.call(this),this.mongo_module=require("mongodb"),this.__mongo_promise=o.create(),this.__mongo_acquired=!1},_tableClass:function(){return e},mongo_object_id:function(t){return this.mongo_module.ObjectId},generate_object_id:function(t){return new this.mongo_module.ObjectId},mongodb:function(){if(!this.__mongo_acquired){this.__mongo_acquired=!0;var t=o.create(),e=a.extend(this._options,{useUnifiedTopology:!0,useNewUrlParser:!0});this.mongo_module.MongoClient.connect(this.__dbUri,e,t.asyncCallbackFunc()),t.success(function(t){this.__mongodb=t.db(this.__databaseName),this.__client=t,this.__mongo_promise.asyncSuccess(this.__mongodb)},this)}return this.__mongo_promise},destroy:function(){this.__client&&this.__client.close(),s.destroy.call(this)}}})})}).call(Scoped);